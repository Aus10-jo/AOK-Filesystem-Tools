#!/bin/sh

#
#  This builds an iSH-AOK Filesystem
#

#  shellcheck disable=SC1007
FS_BUILD_D=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)

#
#  Ensure this is run in the intended location in case this was launched from
#  somewhere else.
#
cd "$FS_BUILD_D" || exit 1

# Read in vars
# shellcheck disable=SC1091
. ./BUILD_ENV

prog_name=$(basename "$0")
main_param="$1"
skip_finalize="dont_compress"


case "$main_param" in

    "-h" | "--help")
        echo "usage: $prog_name [-h] | [--help] | [$skip_finalize]"
        echo "This builds the iSH-AOK filesystem. If given the parameter:"
        echo "  $skip_finalize"
        echo "The process will halt once the FS is ready, giving you the"
        echo "opportunity to chroot into it and do your personal adaptations."
        echo
        echo "Instructions about this procedure and howto then complete the build"
        echo "once done will be displayed at the end of the build."
        echo
        echo "Be aware that this build can only complete on iSH or Linux (x86)!"
        echo
        exit 0
        ;;

    "" | "$skip_finalize")
        ;; # valid options, continue

    *)
        echo "ERROR: bad param, try -h"
        exit 1
        ;;

esac

if [ "$(whoami)" != "root" ]; then
    echo "ERROR: This must be run as root or using sudo!"
    echo
    "$FS_BUILD_D/$prog_name" -h
    exit 1
fi


echo
echo "=====  Building a $ALPINE_RELEASE iSH-AOK filesystem  ====="
echo

if [ "$main_param" = "$skip_finalize" ]; then
    echo "*** Will not create the compressed image! ***"
fi

if [ "$(uname -s)" = "Darwin" ]; then
    echo "Unfortunately this does not run on MacOS at this time"
    exit 1
fi


echo
echo "---  Preparing build environment  ---"

#
# Clear build env
if ! rm -rf "$BUILD_BASE_D"; then
    echo
    echo "ERROR: Could not clear $BUILD_BASE_D"
    echo
    exit 1
fi

# Download the Alpine miniroot if we need to
if [ ! -f "$MINIROOT_FS" ]; then
    echo "Caching miniroot"
    wget "https://dl-cdn.alpinelinux.org/alpine/v$ALPINE_RELEASE/releases/x86/$MINIROOT_FS"
fi

# Build in /tmp
echo "Create $BUILD_ROOT_D, copy minirootfs"
mkdir -p "$BUILD_ROOT_D"


#
#  TODO: Normally I would have put the common part of the command in
#  a variable to make sure they are in sync, but I just couldn't get that
#  to work, some escapes needed?  Should be fixed
#
if [ -f "/proc/ish" ]; then
    busybox tar cf - --exclude='.git' --exclude='./main' --exclude='./save' . | (cd "$BUILD_ROOT_D" || exit 1;tar xf -)
else
    tar cf - --exclude='.git' --exclude='./main' --exclude='./save' . | (cd "$BUILD_ROOT_D" || exit 1;tar xf -)
fi

cd "$BUILD_ROOT_D" || exit 1

# Unzip Alpine, remove tar.gz
gunzip -c "$MINIROOT_FS" | tar xf -

# remove instance inside build dir
rm "$BUILD_ROOT_D"/alpine-minirootfs-*

# We need a valid resolv.conf
cp /etc/resolv.conf "$BUILD_ROOT_D/etc"


echo "Populating /AOK on new filesystem"

AOK_FILES="$BUILD_ROOT_D/AOK"

mkdir "$AOK_FILES"

mv "$BUILD_ROOT_D"/BUILD_ENV             "$AOK_FILES"
mv "$BUILD_ROOT_D"/AOK_VARS              "$AOK_FILES"
mv "$BUILD_ROOT_D"/build_fs              "$AOK_FILES"
mv "$BUILD_ROOT_D"/setup_image_chrooted  "$AOK_FILES"
mv "$BUILD_ROOT_D"/compress_image        "$AOK_FILES"
mv "$BUILD_ROOT_D"/LICENSE               "$AOK_FILES"
mv "$BUILD_ROOT_D"/Files                 "$AOK_FILES"
mv "$BUILD_ROOT_D"/Docs                  "$AOK_FILES"

chown -R root:root "$AOK_FILES"

echo
echo "=====  Doing some FS cleanup  ====="
echo

rm "$BUILD_ROOT_D"/.gitignore
rm "$BUILD_ROOT_D"/README.md
rm "$BUILD_ROOT_D"/TODO.md
rm -rf "$BUILD_ROOT_D"/tools

#
# And now for the main bit
#
chroot_cmd="/AOK/setup_image_chrooted"

if true; then
    # dedicated chroot app
    if ! "$FS_BUILD_D"/tools/do_chroot.sh "$chroot_cmd"; then
        echo "ERROR in chroot, aborting build!"
        exit 1
    fi
else
    # simple chroot
    if ! chroot "$BUILD_ROOT_D" "$chroot_cmd"; then
        echo "ERROR in chroot, aborting build!"
        exit 1
    fi
    echo "---  Cleanup chroot /dev  ---"
    rm "$BUILD_ROOT_D"/dev/*
fi

echo
echo "The filesystem is ready!"

if [ "$main_param" = "$skip_finalize" ]; then
    echo
    echo "You can work on the filesystem by running:"
    echo "  sudo tools/do_chroot.sh"
    echo
    echo "Complete the process by running:"
    echo "  sudo ./compress_image"
    echo
    echo "This creates the compressed image that can be imported into AOK/iSH."
    echo "You can revisit the filesystem by doing the above do_chroot and then"
    echo "build_finish again, in case you need to do further tweaks."
    echo "Running build again will erase the current iSH filesystem and create"
    echo "a fresh instance."
    echo
    exit 0
fi

if ! "$FS_BUILD_D"/compress_image; then
    echo "ERROR detected in compress_image"
    exit 1
fi
