#!/bin/sh
#
#  Script to do various things related to the configuration of ish
#
version="0.2.0  2022-06-12"

. /AOK/AOK_VARS

verbose=0
prog_name=$(basename "$0")


show_help() {
    cat <<EOF
Usage: $prog_name [-h] [-v] [-l login procedure]

An AOK-only script that manages iSH/AOK specific things.

Currently only login procedure can be altered.

Available options:

-h, --help      Print this help and exit
-l, --login     Decides login procedure [once|disable|enable]
EOF
    exit 0
}


if [ -h /bin/login ]; then
    echo "ERROR: Alpine $ALPINE_RELEASE does not support changing login method!"
    exit 1
fi


change_login_procedure() {
    case "$1" in

    "once")
        echo "Enabling login prompt, but only for initial login.  " \
             "AOK app will exit when you logout"
        cp /bin/login.once /bin/login
        exit 0
        ;;

    "enable")
        echo "Enabling login prompt.  You will be prompted for your " \
             "login name and password if one has been set " \
             "when launching AOK"
        cp /bin/login.loop /bin/login
        exit 0
        ;;

    "disable")
        echo "Disabling login prompt on startup.  You will start at " \
             "root prompt where launching AOK"
        cp /bin/login.alpine /bin/login
        exit 0
        ;;

    "")
        echo
        echo "ERROR: Missing param indicating new login procedure"
        exit 1
        ;;

    *)
        echo
        echo "ERROR: Bad param to change login procedure: $1"
        exit 1
        ;;

    esac
}


# execute again as root
if [ "$(whoami)" != "root" ]; then
    echo "Executing as root"
    # using $0 instead of full path makes location not hardcoded
    sudo "$0" "$@"
    exit 0
fi


echo "$prog_name  $version"

while true; do
    case "$1" in

    "" | "-h" | "--help" )
        show_help
        ;;

    "-v" | "--verbose" )
        if [ "$verbose" -eq 0 ]; then
            echo "===  Enabling verbose mode  ==="
            verbose=1
            set -x
        else
            echo
            echo "WARNING: Multiple verbose options are ignored"
        fi
        ;;

    "-l" | "--login" )
        change_login_procedure "$2"
        ;;

    *)
        echo
        echo "ERROR: Bad option: $1"
        echo
        show_help
        ;;

    esac
    shift
    [ -z "$1" ] && break  # no more options
done
