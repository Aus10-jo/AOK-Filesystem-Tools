#!/bin/ash
#

# Switch extra locking on or off


if ! [[ -f /proc/ish/defaults/enable_extralocking ]]
then 
   echo "Not running on iSH-AOK, exiting."
   exit 1;
fi

WHO=`whoami`

# execute again as root
if [ "$WHO" != "root" ]; then
     sudo /usr/local/bin/elock $1
     exit 0
fi

function usage() {
    echo
    echo "Switch extra locking on or off."    
    echo "Switching it on may improve stability but impacts performance"
    echo
    echo "elock <on|off|status>"
    echo
}

if [[ -z $1 ]]; then 
    usage
    exit 1
fi

# Start options for special cases

if [[ "$1" = "on" ]]; then 
    echo "true" > /proc/ish/defaults/enable_extralocking
    exit 0
elif [[ "$1" = "off" ]]; then 
    echo "false" > /proc/ish/defaults/enable_extralocking
    exit 0
elif [[ "$1" = "status" ]]; then 
    STATE=`cat /proc/ish/defaults/enable_extralocking`
    if [[ "$STATE" = "true" ]]; then 
        echo "on"
    elif [[ "$STATE" = "false" ]]; then 
        echo "off"
    fi
    exit 0
fi

echo "Unknown option $1"

exit 1
