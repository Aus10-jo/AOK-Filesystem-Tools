#!/bin/ash
# Simple wrapper script to build iSH root image in a chroot

# Check to be sure we are not running this in /tmp/AOK

# Read in vars
. VARS

# Clean up previous run
rm -rf /tmp/AOK


# Build in /tmp
echo "Create /tmp/AOK/build, copy stuff"
mkdir -p /tmp/AOK/build
tar cf - . --exclude .git --exclude main| (cd /tmp/AOK/build;tar xf -)
cd /tmp/AOK

# Get apk if not installed
if [ ! -f /sbin/apk ]; then
    echo "Installing APK"
    Files/bin/get_apk
fi

# Download the Alpine miniroot
wget http://dl-cdn.alpinelinux.org/alpine/v3.12/releases/x86/alpine-minirootfs-$ALPINE_VERSION-x86.tar.gz

cd build
# Unzip Alpine
gunzip -c ../alpine-minirootfs-3.12.1-x86.tar.gz | tar xf -

# We need a valid resolv.conf
cp /etc/resolv.conf /tmp/AOK/build/etc

# And now for the main bit
chroot /tmp/AOK/build ./build_image

cd /tmp/AOK

# Clean up
mkdir build/AOK
mv build/build_image build/AOK
mv build/chroot_build_image build/AOK
mv build/LICENSE build/AOK
mv build/VARS build/AOK
mv build/Files build/AOK
mv build/Docs build/AOK

# Tar up and zip the result

cd build

tar cvf - . | gzip -9 > ../ALPINE_$ALPINE_VERSION-iSH-AOK_$AOK_VERSION.tgz
