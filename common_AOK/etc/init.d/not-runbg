#!/sbin/openrc-run
#
#  Part of https://github.com/emkey1/AOK-Filesystem-Tools
#
#  License: MIT
#
#  Copyright (c) 2023: Jacob.Lundqvist@gmail.com
#

### BEGIN INIT INFO
# Provides:          runbg
# Required-Start:    $local_fs 
# Required-Stop:     $local_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Polls GPS to allow iSH to run in background
# Description:       By monitoring GPS, iOS allows apps to continue to run in
#                    the background. However there is no guarantee,
#                    If resources run low, backgrounded apps will be
#                    suspended, only resuming when put in foreground again.
### END INIT INFO
#
#  This service reads the GPS and discards the output to /dev/null.
#  So this is not tracking you in any way. The sole purpose of this
#  is that this is the only way to ensure an iOS program continues to run
#  in the background.
#  This process has no noticeable impact on battery life.
#

name="run in background"
description="Reads GPS to ensure iSH continues to run when in background"

command="/bin/cat"
command_args="/dev/location > /dev/null"
command_background="YES"

pidfile="/run/runbg.pid"


#
#  The above is all that is needed to have cat /dev/location > /dev/null
#  run as a simple daemon with pid being monitored.
#
#  The below parts are just adding some additional sanity, not needed
#  in order for the daemon to work by itself.
#
#  Pointless to have more than one thing doing this.
#  The below aborts with error if:  cat /dev/location
#  is already running.
#  And displays warning if other processes are detected
#  after stoping.
#

check_for_other_polling() {
    #  Argh Alpine (BusyBox) displays pid,user instead of user,pid
    if [ -f /etc/alpine-release ]; then
        ps_cmd="ps axu -o user,pid,args"
    else
        ps_cmd="ps axu"
    fi
    other_pids="$($ps_cmd | grep /dev/location | grep -v grep | awk '{ print $2 }' |  tr '\n' ' ')"
}


start_pre() {
    check_for_other_polling
    if [ "$other_pids" != "" ]; then
	eerror "ERROR: Other processes polling GPS [ $other_pids]"
   fi
}


stop_post() {
    check_for_other_polling
    if [ "$other_pids" != "" ]; then
	ewarn "WARNING: Other processes polling GPS [ $other_pids]"
   fi
}
